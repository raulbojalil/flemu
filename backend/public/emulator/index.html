<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div style="width:100%;height:100%;">
    <div id="game"></div>
</div>
<script type="text/javascript">

    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    
    const folder = params.core;
    let core = params.core;

    if(core === "gbc") core = "gb";
    else if(core === "wsc") core = "ws";
    else if(core === "igs" || core === "neogeo") core = "arcade";

    EJS_player = '#game';

    //TODO: Implement the BIOS for systems that require it
    EJS_biosUrl = ''; // Url to Bios file
    EJS_gameUrl = '/filemanager/download?folder=' + folder + '&filename=' + params.filename; // Url to Game rom
    EJS_core = params.core;
    EJS_pathtodata = 'data/'; //path to all of the wasm and js files. MUST all be in the same directory!!
    EJS_AdUrl = ''; //path to AD page

    EJS_onSaveState = function(stateInfo) {
        const state = encode(stateInfo.state);
        const screenshot = encode(stateInfo.screenshot);

       const url = "/filemanager/savestate";
       fetch(url, { 
             method: 'POST', 
             body: JSON.stringify({ system: folder, name: params.filename, state, screenshot }), 
             headers: { 'Content-Type': 'application/json' } })
         .then(res => res.json())
         .then(res => console.log(res));
    };


    EJS_onLoadState = function(loadFn) {
       var url = "/filemanager/loadstate?name=" + params.filename + "&system=" + folder;
       fetch(url, { 
             method: 'GET', 
             headers: { 'Content-Type': 'application/json' } })
         .then(res => res.json())
         .then(res => { 
             if(res.state) {
      	        const state = decode(res.state);
                EJS_loadState(state);
             }
         });
    };

    //Code taken from
    //https://github.com/niklasvh/base64-arraybuffer/blob/master/src/index.ts

    const encode = function(bytes) {

        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
        let base64 = "";

        for (i = 0; i < bytes.length; i += 3) {
            base64 += chars[bytes[i] >> 2];
            base64 += chars[((bytes[i] & 3) << 4) | (bytes[i + 1] >> 4)];
            base64 += chars[((bytes[i + 1] & 15) << 2) | (bytes[i + 2] >> 6)];
            base64 += chars[bytes[i + 2] & 63];
        }

        if (bytes.length % 3 === 2) {
            base64 = base64.substring(0, base64.length - 1) + '=';
        } else if (bytes.length % 3 === 1) {
            base64 = base64.substring(0, base64.length - 2) + '==';
        }

        return base64;
    };

    const decode = function(base64) {

        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';

        // Use a lookup table to find the index.
        const lookup = typeof Uint8Array === 'undefined' ? [] : new Uint8Array(256);
        for (let i = 0; i < chars.length; i++) {
            lookup[chars.charCodeAt(i)] = i;
        }

        let bufferLength = base64.length * 0.75,
            len = base64.length,
            i,
            p = 0,
            encoded1,
            encoded2,
            encoded3,
            encoded4;

        if (base64[base64.length - 1] === '=') {
            bufferLength--;
            if (base64[base64.length - 2] === '=') {
                bufferLength--;
            }
        }

        const arraybuffer = new ArrayBuffer(bufferLength),
            bytes = new Uint8Array(arraybuffer);

        for (i = 0; i < len; i += 4) {
            encoded1 = lookup[base64.charCodeAt(i)];
            encoded2 = lookup[base64.charCodeAt(i + 1)];
            encoded3 = lookup[base64.charCodeAt(i + 2)];
            encoded4 = lookup[base64.charCodeAt(i + 3)];

            bytes[p++] = (encoded1 << 2) | (encoded2 >> 4);
            bytes[p++] = ((encoded2 & 15) << 4) | (encoded3 >> 2);
            bytes[p++] = ((encoded3 & 3) << 6) | (encoded4 & 63);
        }

        return bytes;
    };

</script>
<script src="data/loader.js"></script>
<style>
body, html{
    margin: 0;
    padding: 0;
}
</style>